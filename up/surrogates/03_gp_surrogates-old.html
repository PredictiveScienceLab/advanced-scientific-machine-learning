
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Example of Gaussian Process Surrogate &#8212; Advanced Scientific Machine Learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'up/surrogates/03_gp_surrogates-old';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Advanced Scientific Machine Learning - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Advanced Scientific Machine Learning - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Advanced Scientific Machine Learning
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ml-software/intro.html">Modern Machine Learning Software</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ml-software/functional_programming/00_intro.html">Functional Programming</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/functional_programming/01_primer.html">A Primer on Functional Programming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/functional_programming/02_jit.html">Just in Time Compilation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/functional_programming/03_vectorization.html">Vectorization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/functional_programming/04_random.html">Pseudo Random Numbers without Side Effects</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ml-software/types_and_models/00_intro.html">Type Systems, Pytrees, and Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/types_and_models/01_why.html">Type Systems and why We Care</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/types_and_models/02_typing.html">Python Type Annotations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/types_and_models/03_haskell.html">Haskell Type System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/types_and_models/04_pytrees.html">Pytrees to represent model parameters</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ml-software/differentiation/00_intro.html">Differentiable Programming</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/differentiation/01_numerical.html">Numerical Differentiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/differentiation/02_symbolic.html">Symbolic Differentiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/differentiation/03_autodiff.html">Automatic Differentiation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/differentiation/04_jax_grad.html">Autograd with JAX</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ml-software/optimization/00_intro.html">Optimization for Scientific Machine Learning</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/01_optimization_problems.html">Basics of Optimization Problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/02_gradient_descent.html">Gradient Descent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/03_momentum.html">Gradient Descent with Momentum</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/04_optax.html"><code class="docutils literal notranslate"><span class="pre">Optax</span></code> - Optimizers in JAX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/05_sgd.html">Stochastic Gradient Descent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/06_adaptive.html">Optimization Algorithms with Adaptive Learning Rates</a></li>

<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/07_second_order.html">Second-order Methods for Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/08_initialization.html">Initialization of Neural Network Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ml-software/optimization/09_gpu_training.html">Training a neural network on the GPU</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro.html">Uncertainty Propagation through Scientific Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../sensitivity_analysis/00_intro.html">Sensitivity Analysis of ODEs and PDEs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/01_theory.html">Local Sensitivity Analysis for Ordinary Differential Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/02_diff_ode.html">Differentiating the Solution of Ordinary Differential Equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/03_example_ode.html">Example: The Duffing Oscillator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/04_example_lorenz.html">Example: Lorenz System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/05_fokker_planck.html">Beyond Local Sensitivity Analysis: The Fokker-Planck Equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/06_lhs.html">Latin Hypercube Designs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/07_sobol.html">Sobol’s Sequence</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sensitivity_analysis/08_global_sensitivity_analysis.html">Global Sensitivity Analysis</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../polynomial_chaos/00_intro.html">Uncertainty Propagation using Polynomial Chaos</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/01_functional_analysis.html">Required Functional Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/02_pc_uniform.html">Symbolic Construction of Polynomial Chaos for Uniform Random Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/03_pc_hermite.html">Symbolic Construction of Polynomial Chaos for Gaussian Random Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/04_orthpol_demo.html">Numerical Estimation of Orthogonal Polynomials</a></li>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/05_pc_ode_1d.html">Using Polynomial Chaos to Propagate Uncertainty through an ODE</a></li>

<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/06_tensor_product.html">Polynomial Chaos in Many Dimensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/07_pce_dynamical_system.html">Uncertainty Propagation in Dynamical Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../polynomial_chaos/08_limitations.html">Limitations of Polynomial Chaos</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="intro.html">Surrogates Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="01_basics_of_surrogate_models.html">Basic Elements of Surrogate Modeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="02_nn_surrogates.html">Example of a Neural Network Surrogate</a></li>
<li class="toctree-l3"><a class="reference internal" href="03_gp_surrogates.html">Example of Gaussian Process Surrogate</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../mf/intro.html">Multi-fidelity Surrogates</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../mf/01_mf_basics.html">Multifidelity modeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mf/02_mf_gps.html">Multifidelity Gaussian process surrogates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mf/03_mf_nn.html">Multi-fidelity Neural Networks</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../al/intro.html">Active Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../symmetries/intro.html">Embedding Symmetries in Surrogate Models</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../hup/intro.html">High-dimensional Uncertainty Propagation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../hup/funcin/intro.html">Functional Inputs to Scientific Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hup/op/intro.html">Operator Learning</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../inverse/intro.html">Inverse Problems in Deterministic Scientific Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../inverse/basics/intro.html">Basics of Inverse Problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inverse/sampling/intro.html">Sampling from Posteriors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inverse/vi/intro.html">Variational Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inverse/hbayes/intro.html">Hierarchical Bayesian Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../inverse/odes/intro.html">Deterministic, Finite-dimensional, Dynamical Systems</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../sinverse/intro.html">Inverse Problems in Stochastic Scientific Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../sinverse/sodes/intro.html">Stochastic Differential Equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sinverse/fs/intro.html">Filtering and Smoothing</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../pinns/intro.html">Physics-informed Neural Networks (PINNs)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../pinns/basics/intro.html">Basics of Physics-Informed Neural Networks</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../pinns/basics/forward.html">Physics-Informed Neural Networks (PINNs) - Forward Problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pinns/basics/spectral_bias.html">Spectral Bias of Neural Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../pinns/basics/energy.html">Energy Functionals</a></li>

</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../pinns/parametric/intro.html">PINNS for Parametric Studies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../pinns/parametric/parametric_example.html">Solving Parametric Problems using Physics-informed Neural Networks</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../pinns/inverse/intro.html">PINNS for Inverse Problems</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ift/intro.html">Information Field Theory (IFT)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ift/fields/intro.html">Bayesian Inference over Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ift/physics/intro.html">Physics-informed Information Field Theory (PIFT)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ift/calibration/intro.html">Parameter Calibration with PIFT</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/PredictiveScienceLab/advanced-scientific-machine-learning/blob/master/book/up/surrogates/03_gp_surrogates-old.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/up/surrogates/03_gp_surrogates-old.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example of Gaussian Process Surrogate</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-for-subcutaneous-autoinjectors">Model for subcutaneous autoinjectors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-regression">Gaussian process regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prior">Prior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#likelihood">Likelihood</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#posterior">Posterior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizing-hyperparameters">Optimizing hyperparameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#predictive-distribution-how-to-evaluate-the-gp">Predictive distribution: How to evaluate the GP?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-how-much-data-do-we-need">Convergence: How much data do we need?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnostics-how-good-is-the-surrogate">Diagnostics: How good is the surrogate?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parity-plot">Parity plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#standardized-errors">Standardized errors</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#error-histogram">Error histogram</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#qq-plot">QQ plot</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#residuals-plot">Residuals plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitivity-analysis-with-surrogate">Sensitivity analysis with surrogate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-and-inference">Training and inference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-exact-gp-regression">Option 1: Exact GP regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-approximate-gp-regression">Option 2: Approximate GP regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-optimization">Design optimization</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-input tag_hide-output docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib_inline</span>
<span class="n">matplotlib_inline</span><span class="o">.</span><span class="n">backend_inline</span><span class="o">.</span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;paper&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;ticks&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">vmap</span>
<span class="kn">import</span> <span class="nn">jax.random</span> <span class="k">as</span> <span class="nn">jrandom</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">jax.scipy.stats</span> <span class="k">as</span> <span class="nn">jstats</span>
<span class="kn">import</span> <span class="nn">equinox</span> <span class="k">as</span> <span class="nn">eqx</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gpjax</span> <span class="k">as</span> <span class="nn">gpx</span>
<span class="kn">from</span> <span class="nn">flax</span> <span class="kn">import</span> <span class="n">nnx</span>
<span class="kn">import</span> <span class="nn">optax</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">QuantileTransformer</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">jaxtyping</span> <span class="kn">import</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Array</span>

<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jrandom</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/holtw/Documents/mydocs/software/advanced-scientific-machine-learning/.venv/lib/python3.11/site-packages/cola/backends/backends.py:75: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
  torch.utils._pytree._register_pytree_node(cls, tree_flatten, tree_unflatten)
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="example-of-gaussian-process-surrogate">
<h1>Example of Gaussian Process Surrogate<a class="headerlink" href="#example-of-gaussian-process-surrogate" title="Link to this heading">#</a></h1>
<section id="model-for-subcutaneous-autoinjectors">
<h2>Model for subcutaneous autoinjectors<a class="headerlink" href="#model-for-subcutaneous-autoinjectors" title="Link to this heading">#</a></h2>
<p>In this notebook, we will create a Gaussian process (GP) surrogate of an expensive biomechanical model (see <a class="reference external" href="https://doi.org/10.1016/j.jmbbm.2023.105695">Sree et. al. (2023)</a>).</p>
<section id="background">
<h3>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h3>
<p>Autoinjectors are drug delivery devices that work kind of like an automated syringe.
Basically, you put the device against the patient’s skin, press a button, and a spring within the device pushes the needle and drug is released inside the patient.</p>
<!-- Autoinjectors are nice because they simplify the injection process for the user so that patients can self-administer at home.  -->
<p>Below is a picture of an autoinjector:</p>
<img src="autoinjector.png" alt="autoinjector" width="600"/>
<p>To efficently design an optimal autoinjector, you need a computational model of the injection process.
To this end, <a class="reference external" href="https://doi.org/10.1016/j.jmbbm.2023.105695">Sree et. al. (2023)</a> present a biomechanical model of injection into subcutaneous tissue (i.e., the tissue right below your skin) via an autoinjector.</p>
<p>The model, however, is expensive to evaluate—multiple hours on several parallel processors for one evaluation.
This is too slow for things like design optimization or uncertainty quantification.
So we will speed it up with by training a surrogate.
Let’s get started.</p>
</section>
<section id="dataset">
<h3>Dataset<a class="headerlink" href="#dataset" title="Link to this heading">#</a></h3>
<p>To train the surrogate, we use a dataset with thousands of evaluations of the expensive model (data was provided by the authors <a class="reference external" href="https://doi.org/10.1016/j.jmbbm.2023.105695">Sree et. al. (2023)</a>).
Let’s import the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define new names for each input/output variable</span>
<span class="n">old_input_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;hGap0&#39;</span><span class="p">,</span> <span class="s1">&#39;lNeedle&#39;</span><span class="p">,</span> <span class="s1">&#39;dNeedle&#39;</span><span class="p">,</span> <span class="s1">&#39;FSpring0&#39;</span><span class="p">,</span> <span class="s1">&#39;kSpring&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa5&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa6&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa7&#39;</span><span class="p">]</span>
<span class="n">INPUT_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;viscosity_cP&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_volume_mL&#39;</span><span class="p">,</span> <span class="s1">&#39;air_gap_height_mm&#39;</span><span class="p">,</span> <span class="s1">&#39;needle_length_mm&#39;</span><span class="p">,</span> <span class="s1">&#39;needle_diameter_mm&#39;</span><span class="p">,</span> <span class="s1">&#39;spring_force_N&#39;</span><span class="p">,</span> <span class="s1">&#39;spring_constant_N_per_mm&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa5&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa6&#39;</span><span class="p">,</span> <span class="s1">&#39;kappa7&#39;</span><span class="p">]</span>
<span class="n">old_output_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Needle displacement (m)&#39;</span><span class="p">,</span> <span class="s1">&#39;Injection time (s)&#39;</span><span class="p">,</span> <span class="s1">&#39;max. acceleration (m/s^2)&#39;</span><span class="p">,</span> <span class="s1">&#39;max. deceleration (m/s^2)&#39;</span><span class="p">]</span>
<span class="n">OUTPUT_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;needle_displacement_m&#39;</span><span class="p">,</span> <span class="s1">&#39;injection_time_s&#39;</span><span class="p">,</span> <span class="s1">&#39;max_acceleration_m_per_s2&#39;</span><span class="p">,</span> <span class="s1">&#39;max_deceleration_m_per_s2&#39;</span><span class="p">]</span>
<span class="n">column_name_mapper</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">old_input_names</span> <span class="o">+</span> <span class="n">old_output_names</span><span class="p">,</span> <span class="n">INPUT_NAMES</span> <span class="o">+</span> <span class="n">OUTPUT_NAMES</span><span class="p">))</span>

<span class="c1"># Load the data</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;training_data.xlsx&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_name_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;test_data.xlsx&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_name_mapper</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Split data. Pass in column names to ensure correct order.</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">INPUT_NAMES</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">INPUT_NAMES</span><span class="p">)</span>  
<span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">OUTPUT_NAMES</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">OUTPUT_NAMES</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">INPUT_NAMES</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">INPUT_NAMES</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="n">OUTPUT_NAMES</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">OUTPUT_NAMES</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The model has 10 inputs and 4 outputs. The inputs are things like drug viscosity, needle size, tissue properties, etc. The outputs are the maximum acceleration/deceleration of fluid in syringe, the total time of injection, and the depth of needle insertion at the onset of drug delivery.</p>
</section>
<section id="preprocessing">
<h3>Preprocessing<a class="headerlink" href="#preprocessing" title="Link to this heading">#</a></h3>
<p>Ideally, we want the input and output data to be standarized and more-or-less evenly distributed. This helps avoid any numerical difficulties when training GPs.</p>
<p>Let’s visualize the distribution of each input:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Input data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">INPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/675c79e933534212909ad7ea1ab450b98c4bab1da4a2d2eacb9cbcb8b878ffe7.svg" src="../../_images/675c79e933534212909ad7ea1ab450b98c4bab1da4a2d2eacb9cbcb8b878ffe7.svg" />
</div>
</div>
<p>They are evenly distributed, but not standarized (i.e., the means and standard deviations are not 0 and 1, respectively). Let’s standardize the input data:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StandardScaler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A transform that standarizes the data to have mean=0 and stdev=1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : Float[Array, &quot;N d&quot;]</span>
<span class="sd">        The data to be standarized. Shape is (N, d)=(number of samples, dimensionality).</span>
<span class="sd">    pretransform_forward : Optional[callable]</span>
<span class="sd">        An optional transformation to apply to the data before standarizing.</span>
<span class="sd">    pretransform_inverse : Optional[callable]</span>
<span class="sd">        The inverse of pretransform_forward.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">data</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot;N d&quot;</span><span class="p">],</span> 
        <span class="n">pretransform_forward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">pretransform_inverse</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="c1"># Set up pre-transform functions</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pretransform_forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">pretransform_inverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both pretransform_forward and pretransform_inverse must be provided.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pretransform_forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pretransform_forward</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
            <span class="n">pretransform_inverse</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_forward</span> <span class="o">=</span> <span class="n">pretransform_forward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_inverse</span> <span class="o">=</span> <span class="n">pretransform_inverse</span>
        
        <span class="c1"># Compute parameters for the standarizer</span>
        <span class="n">pretransformed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_forward</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pretransformed_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pretransformed_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>        
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
    
    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_inverse</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_transform</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s visualize the distribution of each output:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Output data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/7bb6664f27ef97096291aaf7ad7f2a762540501a732091155cd1f358f214dabb.svg" src="../../_images/7bb6664f27ef97096291aaf7ad7f2a762540501a732091155cd1f358f214dabb.svg" />
</div>
</div>
<p>Some of the outputs are skewed. Let’s apply a log transformation, then standarize the output data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@vmap</span>
<span class="k">def</span> <span class="nf">partial_log_transform</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

<span class="nd">@vmap</span>
<span class="k">def</span> <span class="nf">partial_exp_transform</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

<span class="n">output_transform</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">pretransform_forward</span><span class="o">=</span><span class="n">partial_log_transform</span><span class="p">,</span> <span class="n">pretransform_inverse</span><span class="o">=</span><span class="n">partial_exp_transform</span><span class="p">)</span>
<span class="n">y_train_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">y_test_scaled</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">y_test</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Okay, now let’s visualize the transformed inputs and outputs:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Transformed input data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">INPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Transformed output data&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_train_scaled</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/e99487c611578a1e1b75296b75f6439a944cd1b040698960e1008e8d532028e8.svg" src="../../_images/e99487c611578a1e1b75296b75f6439a944cd1b040698960e1008e8d532028e8.svg" />
<img alt="../../_images/026a94905f9a624b41d25e2040223401f0a53b037df766fac9e7e5d0718a0330.svg" src="../../_images/026a94905f9a624b41d25e2040223401f0a53b037df766fac9e7e5d0718a0330.svg" />
</div>
</div>
<p>Nice! The input/output data are all more-or-less evenly distributed and standarized. Now on to building the Gaussian process.</p>
</section>
</section>
<section id="gaussian-process-regression">
<h2>Gaussian process regression<a class="headerlink" href="#gaussian-process-regression" title="Link to this heading">#</a></h2>
<p>We will use <code class="docutils literal notranslate"><span class="pre">GPJax</span></code> to construct 4 different GP surrogates, one for each output. We’ll write the math down for one of the outputs, but the same applies to the other outputs.</p>
<section id="prior">
<h3>Prior<a class="headerlink" href="#prior" title="Link to this heading">#</a></h3>
<p>First, let’s create the GP prior with zero mean, i.e.,</p>
<div class="math notranslate nohighlight">
\[
m(x) = 0
\]</div>
<p>and a radial basis function (RBF) as the covariance kernel, i.e.,</p>
<div class="math notranslate nohighlight">
\[
k(x, x') = \sigma^2 \exp\left(-\frac{1}{2} \sum_{i=1}^d \left(\frac{x_i - x'_i}{\ell_i}\right)^2\right)
\]</div>
<p>where <span class="math notranslate nohighlight">\(\sigma^2\)</span> is the variance and <span class="math notranslate nohighlight">\(\ell_i\)</span> is the length scale for input dimension <span class="math notranslate nohighlight">\(i\)</span>. We write the prior as</p>
<div class="math notranslate nohighlight">
\[
f \sim \mathcal{GP}(m, k).
\]</div>
<p>Here is how to do it in <code class="docutils literal notranslate"><span class="pre">GPJax</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Zero mean</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">mean_functions</span><span class="o">.</span><span class="n">Zero</span><span class="p">()</span>

<span class="c1"># Set the lengthscale/variance to decent values - they will be optimized later.</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span><span class="n">lengthscale</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">variance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># GP prior</span>
<span class="n">prior</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">gps</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="n">mean_function</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="likelihood">
<h3>Likelihood<a class="headerlink" href="#likelihood" title="Link to this heading">#</a></h3>
<p>We’ll use a Gaussian likelihood. For input data</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{X} \equiv \begin{bmatrix} \mathbf{x}_1 \\ \vdots \\ \mathbf{x}_N \end{bmatrix} \in \mathbb{R}^{N \times d}
\end{split}\]</div>
<p>and output data</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\mathbf{y} \equiv \begin{bmatrix} y_1 \\ \vdots \\ y_N \end{bmatrix} \in \mathbb{R}^N
\end{split}\]</div>
<p>we have that</p>
<div class="math notranslate nohighlight">
\[
y_i|f, \mathbf{x}_i \sim \mathcal{N}(f(\mathbf{x_i}), \sigma_n^2) \quad \text{independently for } i = 1, \ldots, N,
\]</div>
<p>where <span class="math notranslate nohighlight">\(f\)</span> is the physical model (or a sample from the GP) and <span class="math notranslate nohighlight">\(\sigma_n^2\)</span> is the measurement noise variance. Coding this in <code class="docutils literal notranslate"><span class="pre">GPJax</span></code> is straightworward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">likelihoods</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span>
    <span class="n">num_datapoints</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="c1"># obs_stddev=gpx.parameters.Parameter(0.001, tag=&#39;static&#39;)  # Fixing measurement noise to something small.</span>
    <span class="n">obs_stddev</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="posterior">
<h3>Posterior<a class="headerlink" href="#posterior" title="Link to this heading">#</a></h3>
<p>We can now construct the GP posterior</p>
<div class="math notranslate nohighlight">
\[
f | \mathbf{X}, \mathbf{y} \sim \mathcal{GP}(m_{\text{post}}, k_{\text{post}})
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="optimizing-hyperparameters">
<h3>Optimizing hyperparameters<a class="headerlink" href="#optimizing-hyperparameters" title="Link to this heading">#</a></h3>
<p>For each GP posterior, the hyperparameters are the RBF kernel variance <span class="math notranslate nohighlight">\(\sigma^2\)</span>, lengthscales <span class="math notranslate nohighlight">\(\mathbf{\ell}=(\ell_1, \dots, \ell_d)\)</span>, and measurement noise variance <span class="math notranslate nohighlight">\(\sigma_n^2\)</span>.</p>
<p>Let’s denote the hyperparameters as <span class="math notranslate nohighlight">\(\psi=(\sigma^2, \mathbf{\ell}, \sigma_n^2)\)</span>.
We’ll pick optimal <span class="math notranslate nohighlight">\(\psi\)</span> by maximizing the marginal log likelihood, i.e.,</p>
<div class="math notranslate nohighlight">
\[
\psi^* = \arg\max_{\psi} ~ \log p(\mathbf{y} | \mathbf{X}, \psi).
\]</div>
<p><code class="docutils literal notranslate"><span class="pre">GPJax</span></code> provides the functions <code class="docutils literal notranslate"><span class="pre">conjugate_mll</span></code> and <code class="docutils literal notranslate"><span class="pre">fit</span></code> to do this. (Note that we do everything in a loop so each output gets its own GP surrogate.)</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loss function: negative marginal log likelihood</span>
<span class="n">negative_mll</span> <span class="o">=</span> <span class="n">nnx</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="o">-</span><span class="n">gpx</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">conjugate_mll</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">optimize_gps</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">num_iters</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimizes the hyperparameters in the GP model (separately for each output).&quot;&quot;&quot;</span>
    <span class="n">posteriors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">loss_histories</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Do this in a loop to construct a GP for each output.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jrandom</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">posteriors</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span> <span class="n">loss_histories</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">posterior</span><span class="p">,</span>
            <span class="n">objective</span><span class="o">=</span><span class="n">negative_mll</span><span class="p">,</span>
            <span class="n">train_data</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span>
            <span class="n">optim</span><span class="o">=</span><span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">),</span>  <span class="c1"># Adam optimizer</span>
            <span class="n">num_iters</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">subkey</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">posteriors</span><span class="p">,</span> <span class="n">loss_histories</span>

<span class="k">def</span> <span class="nf">create_datasets</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train_scaled</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a GPJax datasets (one for each output) out of a subset of the training data.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_names</span><span class="p">):</span>
        <span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="n">size</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">datasets</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a separate dataset for each output (and put it all in a single dictionary)</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">create_datasets</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># Optimize the hyperparameters</span>
<span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jrandom</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">posteriors</span><span class="p">,</span> <span class="n">loss_histories</span> <span class="o">=</span> <span class="n">optimize_gps</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">subkey</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "12711e528d254d25bde11ef9f7fbcedf", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/holtw/Documents/mydocs/software/advanced-scientific-machine-learning/.venv/lib/python3.11/site-packages/cola/backends/backends.py:75: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
  torch.utils._pytree._register_pytree_node(cls, tree_flatten, tree_unflatten)
/Users/holtw/Documents/mydocs/software/advanced-scientific-machine-learning/.venv/lib/python3.11/site-packages/cola/backends/backends.py:75: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
  torch.utils._pytree._register_pytree_node(cls, tree_flatten, tree_unflatten)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1edbb56fb6534588a74e4fd92af6ba00", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "0514246853594f37b282158d220dfca5", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "ee8700d880c240c6972be1b18d9f2fe6", "version_major": 2, "version_minor": 0}</script></div>
</div>
<p>We now have an optimized GP for each output!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posteriors</span><span class="p">[</span><span class="s1">&#39;needle_displacement_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">lengthscale</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PositiveReal(
  _tag=&#39;positive&#39;,
  value=Array([0.89398692, 5.37938492, 5.19130139, 1.52742274, 2.12174445,
         2.61498712, 5.09279493, 5.46752322, 2.11813042, 5.12751518],      dtype=float64)
)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="predictive-distribution-how-to-evaluate-the-gp">
<h2>Predictive distribution: How to evaluate the GP?<a class="headerlink" href="#predictive-distribution-how-to-evaluate-the-gp" title="Link to this heading">#</a></h2>
<p>The question now is <strong>how do we use our GPs to make predictions?</strong> The predictive distribution for a new input <span class="math notranslate nohighlight">\(\mathbf{x}^*\)</span> is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
p\big( f(\mathbf{x}^*) \big | \mathcal{D})
= \int \underbrace{p\big( f(\mathbf{x}^*) \big | f(\mathbf{x}) \big)}_{\substack{\text{conditional probability} \\ \text{of output at } \mathbf{x}^*}} \underbrace{p\big(f(\mathbf{x}) \big| \mathcal{D}\big)}_{\substack{\text{posterior GP} \\ \text{evaluated at } \mathbf{x}}} df(\mathbf{x})
\end{split}\]</div>
<p>GPJax provides the function <code class="docutils literal notranslate"><span class="pre">predict</span></code> which can be used to give the mean and variance of the predictive distribution <span class="math notranslate nohighlight">\(p\big( f(\mathbf{x}^*) \big| \mathcal{D} \big)\)</span>. Or, we can sample from the predictive distribution using the function <code class="docutils literal notranslate"><span class="pre">sample</span></code>.</p>
<p>To facilitate making new predictions, let’s wrap <code class="docutils literal notranslate"><span class="pre">predict</span></code> and <code class="docutils literal notranslate"><span class="pre">sample</span></code> with the following helper class, which represents the surrogate:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Surrogate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">models</span><span class="p">,</span> 
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">input_transform</span><span class="p">,</span> 
        <span class="n">input_inv_transform</span><span class="p">,</span>
        <span class="n">output_transform</span><span class="p">,</span> 
        <span class="n">output_inv_transform</span><span class="p">,</span>
        <span class="n">OUT_NAMES</span><span class="o">=</span><span class="n">OUTPUT_NAMES</span><span class="p">,</span> 
        <span class="n">IN_NAMES</span><span class="o">=</span><span class="n">INPUT_NAMES</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="n">train_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span> <span class="o">=</span> <span class="n">input_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_inv_transform</span> <span class="o">=</span> <span class="n">input_inv_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_transform</span> <span class="o">=</span> <span class="n">output_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_inv_transform</span> <span class="o">=</span> <span class="n">output_inv_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span> <span class="o">=</span> <span class="n">OUT_NAMES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IN_NAMES</span> <span class="o">=</span> <span class="n">IN_NAMES</span>
        
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the model at X.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_predictive_mean_stdev</span><span class="p">(</span><span class="n">Z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Just the mean</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_inv_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample the output. Contains both aleatoric and epistemic uncertainty.&quot;&quot;&quot;</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_scaled_predictive</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_inv_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sample_scaled_predictive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample the scaled output. Contains both aleatoric and epistemic uncertainty.&quot;&quot;&quot;</span>
        <span class="n">predictive_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_predictive_dists</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">predictive_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,))</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span>
    
    <span class="k">def</span> <span class="nf">sample_latent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample the latent space of the model (i.e., a GP sample before passing through the likelihood). Contains only epistemic uncertainty.&quot;&quot;&quot;</span>
        <span class="n">latent_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latent_dists</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">latent_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    
    <span class="k">def</span> <span class="nf">get_scaled_predictive_mean_stdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the mean and standard deviation of the scaled output. Contains both aleatoric and epistemic uncertainty.&quot;&quot;&quot;</span>
        <span class="n">predictive_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_predictive_dists</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y_mean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y_stdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span><span class="p">:</span>
            <span class="n">y_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predictive_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="n">y_stdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predictive_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">stddev</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y_stdev</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_latent_mean_stdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the mean and standard deviation of the latent distribution. Contains only epistemic uncertainty.&quot;&quot;&quot;</span>
        <span class="n">latent_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latent_dists</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">f_mean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f_stdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span><span class="p">:</span>
            <span class="n">f_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latent_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="n">f_stdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latent_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">stddev</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">f_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">f_stdev</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_latent_dists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">latent_dists</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span><span class="p">:</span>
            <span class="n">latent_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data</span><span class="p">[</span><span class="n">o_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">latent_dists</span>
    
    <span class="k">def</span> <span class="nf">_get_predictive_dists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">latent_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latent_dists</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">predictive_dists</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OUT_NAMES</span><span class="p">:</span>
            <span class="n">predictive_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="n">latent_dists</span><span class="p">[</span><span class="n">o_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">predictive_dists</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surrogate_</span> <span class="o">=</span> <span class="n">Surrogate</span><span class="p">(</span>
    <span class="n">models</span><span class="o">=</span><span class="n">posteriors</span><span class="p">,</span>
    <span class="n">train_data</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span>
    <span class="n">input_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
    <span class="n">input_inv_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="o">.</span><span class="n">inverse</span><span class="p">,</span>
    <span class="n">output_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
    <span class="n">output_inv_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="o">.</span><span class="n">inverse</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s make a prediction at a new input location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a random test point</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
<span class="n">x_scaled</span> <span class="o">=</span> <span class="n">input_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Evaluate the mean and standard deviation</span>
<span class="n">y_scaled_mean</span><span class="p">,</span> <span class="n">y_scaled_stdev</span> <span class="o">=</span> <span class="n">surrogate_</span><span class="o">.</span><span class="n">get_scaled_predictive_mean_stdev</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The scaled predictions are:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">o_name</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2">:  </span><span class="si">{</span><span class="n">y_scaled_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">y_scaled_stdev</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The scaled predictions are:
	needle_displacement_m    :  -0.03 +/- 0.31
	injection_time_s         :  0.06 +/- 0.06
	max_acceleration_m_per_s2:  0.26 +/- 0.12
	max_deceleration_m_per_s2:  0.03 +/- 0.05
</pre></div>
</div>
</div>
</div>
<p>This is one advantage of GP surrogates—they provide uncertainty estimates!</p>
<p>Let’s visualize the (unscaled) output probability distributions. We can do this by sampling from the GP posterior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_latent_samples</span> <span class="o">=</span> <span class="n">surrogate_</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_latent_samples</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/e8b75eb58aed84c9580089181ad7ff80f599c348c500bcafded3fee02a91748c.svg" src="../../_images/e8b75eb58aed84c9580089181ad7ff80f599c348c500bcafded3fee02a91748c.svg" />
</div>
</div>
<p>The uncertainty you see here is the <em>epistemic uncertainty</em> (or “lack-of-data” uncertainty). It should go down as we add more data points. We’ll look at this next.</p>
</section>
<section id="convergence-how-much-data-do-we-need">
<h2>Convergence: How much data do we need?<a class="headerlink" href="#convergence-how-much-data-do-we-need" title="Link to this heading">#</a></h2>
<p>Ideally, we want to use enough data so that the epistemic uncertainty is low.
Let’s test how much data we need for this problem.
We’ll create training datasets of sizes <span class="math notranslate nohighlight">\(N=50, 500, 1000, 1500, 2000\)</span> and observe the convergence of the trained GP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>
<span class="n">datasets_N</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="p">:</span> <span class="n">create_datasets</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">dataset_sizes</span><span class="p">}</span>

<span class="n">surrogates_N</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">posteriors_N</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">loss_histories_N</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">dataset_sizes</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now training GP for dataset with size </span><span class="si">{</span><span class="n">N</span><span class="si">:</span><span class="s1">&lt;3</span><span class="si">}</span><span class="s1"> ... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jrandom</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">posteriors_N</span><span class="p">[</span><span class="n">N</span><span class="p">],</span> <span class="n">loss_histories_N</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize_gps</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">datasets_N</span><span class="p">[</span><span class="n">N</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">subkey</span><span class="p">)</span>

    <span class="n">surrogates_N</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">Surrogate</span><span class="p">(</span>
        <span class="n">models</span><span class="o">=</span><span class="n">posteriors_N</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
        <span class="n">train_data</span><span class="o">=</span><span class="n">datasets_N</span><span class="p">[</span><span class="n">N</span><span class="p">],</span>
        <span class="n">input_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
        <span class="n">input_inv_transform</span><span class="o">=</span><span class="n">input_transform</span><span class="o">.</span><span class="n">inverse</span><span class="p">,</span>
        <span class="n">output_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="o">.</span><span class="n">forward</span><span class="p">,</span>
        <span class="n">output_inv_transform</span><span class="o">=</span><span class="n">output_transform</span><span class="o">.</span><span class="n">inverse</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Now training GP for dataset with size 50  ... done.
Now training GP for dataset with size 500 ... done.
Now training GP for dataset with size 1000 ... done.
Now training GP for dataset with size 1500 ... done.
Now training GP for dataset with size 2000 ... done.
</pre></div>
</div>
</div>
</div>
<p>We now have trained GPs for each dataset size, stored in <code class="docutils literal notranslate"><span class="pre">surrogates_N</span></code>.
Note how the epistemic uncertainty decreases as we add more data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_latent_samples_N</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_sizes</span><span class="p">):</span>
    <span class="n">y_latent_samples_N</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">surrogates_N</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">.</span><span class="n">sample_latent</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_index</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Select an output</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset_sizes</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_sizes</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epsitemic uncertainty for </span><span class="si">{</span><span class="n">OUTPUT_NAMES</span><span class="p">[</span><span class="n">output_index</span><span class="p">]</span><span class="si">}</span><span class="s1"> (scaled)&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">y_latent_samples_N</span><span class="p">[</span><span class="n">N</span><span class="p">][:,</span><span class="n">output_index</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;N=</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/75a0e83a27599997769a1b27772bb35822dc1ea6d6b2531412946681fbb41586.svg" src="../../_images/75a0e83a27599997769a1b27772bb35822dc1ea6d6b2531412946681fbb41586.svg" />
</div>
</div>
<p>Let’s visualize the convergence for each (scaled) output. Below, we plot the epistemic uncertainty as a vertical bar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means_N</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">stdevs_N</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_sizes</span><span class="p">):</span>
    <span class="n">means_N</span><span class="p">[</span><span class="n">N</span><span class="p">],</span> <span class="n">stdevs_N</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">surrogates_N</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">.</span><span class="n">get_latent_mean_stdev</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Convergence of epistemic uncertainty to zero&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">dataset_sizes</span><span class="p">,</span> <span class="p">[</span><span class="n">means_N</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">dataset_sizes</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">stdevs_N</span><span class="p">[</span><span class="n">N</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">dataset_sizes</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">o_name</span><span class="si">}</span><span class="s1"> (scaled)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># ax[i].set_yticks([])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Dataset size&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/0dfea7520e0edc95975df8c2c6ba4dff8531f40d8ddd05931c3b522a627f27e8.svg" src="../../_images/0dfea7520e0edc95975df8c2c6ba4dff8531f40d8ddd05931c3b522a627f27e8.svg" />
</div>
</div>
<p>For <span class="math notranslate nohighlight">\(N&gt;1000\)</span> the epistemic uncertainty is low for all outputs. We’ll use the GP trained with 1000 points for subsequent analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surrogate</span> <span class="o">=</span> <span class="n">surrogates_N</span><span class="p">[</span><span class="mi">1000</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="diagnostics-how-good-is-the-surrogate">
<h2>Diagnostics: How good is the surrogate?<a class="headerlink" href="#diagnostics-how-good-is-the-surrogate" title="Link to this heading">#</a></h2>
<p>The next question is: <strong>How accurate is our surrogate?</strong> We will use our test dataset to find out.</p>
<section id="parity-plot">
<h3>Parity plot<a class="headerlink" href="#parity-plot" title="Link to this heading">#</a></h3>
<p>Let’s plot the predicted output against the true output (for the test dataset):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means_train</span><span class="p">,</span> <span class="n">stdevs_train</span> <span class="o">=</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">get_scaled_predictive_mean_stdev</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">means_test</span><span class="p">,</span> <span class="n">stdevs_test</span> <span class="o">=</span> <span class="n">surrogate</span><span class="o">.</span><span class="n">get_scaled_predictive_mean_stdev</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rmse</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Verification with training data&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">y_train_scaled</span><span class="p">[:</span><span class="mi">1000</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">means_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">stdevs_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="p">(</span><span class="n">y_train_scaled</span><span class="p">[:</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">means_train</span><span class="p">[:,</span><span class="w"> </span><span class="n">i</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Validation with test data&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">y_test_scaled</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">means_test</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">stdevs_test</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE: </span><span class="si">{</span><span class="n">rmse</span><span class="p">(</span><span class="n">y_test_scaled</span><span class="p">[:,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">means_test</span><span class="p">[:,</span><span class="w"> </span><span class="n">i</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/56b9fdc78218143470c76d8958a91417aa133b575a1e23bea7da0f355c2bbd1b.svg" src="../../_images/56b9fdc78218143470c76d8958a91417aa133b575a1e23bea7da0f355c2bbd1b.svg" />
<img alt="../../_images/fc39b41c4e9b92a95bccfaffa0bbda822a92920e0bf5e723fc6885352e28be59.svg" src="../../_images/fc39b41c4e9b92a95bccfaffa0bbda822a92920e0bf5e723fc6885352e28be59.svg" />
</div>
</div>
<p>As expected, we fit the training data perfectly (all points lie on the red line). However, we mostly care about how well we predict unseen (test) data. The root mean square error (RSME) along with the parity plots show that some outputs are predicted better than others.</p>
<p>For GPs, parity plots and RSME values are good for checking if our predictive <em>mean</em> function is correct. However, they do not say anything about whether our <em>uncertainty</em> estimates are correct. For that, we must look at the standardized errors.</p>
</section>
<section id="standardized-errors">
<h3>Standardized errors<a class="headerlink" href="#standardized-errors" title="Link to this heading">#</a></h3>
<p>For the <span class="math notranslate nohighlight">\(i^\text{th}\)</span> test data point, the <em>standardized error</em> <span class="math notranslate nohighlight">\(e_i\)</span> is</p>
<div class="math notranslate nohighlight">
\[
e_i = \frac{y_i - m(x_i)}{\sigma(x_i)}
\]</div>
<p>where <span class="math notranslate nohighlight">\(y_i\)</span> is the true output, and <span class="math notranslate nohighlight">\(m(x_i)\)</span> and <span class="math notranslate nohighlight">\(\sigma(x_i)\)</span> are the mean and standard deviation of the prediction, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">standardized_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_test_scaled</span> <span class="o">-</span> <span class="n">means_test</span><span class="p">)</span> <span class="o">/</span> <span class="n">stdevs_test</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s use these standardized errors to validate the GP’s uncertainty estimates.</p>
<section id="error-histogram">
<h4>Error histogram<a class="headerlink" href="#error-histogram" title="Link to this heading">#</a></h4>
<p>The basic GP model (which is what we have) assumes normally distributed errors. Let’s check this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Standardized errors&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">standardized_errors</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/ca49675099f9f2ef2a6eefe29fd7c42a1bdc68dd3a15d7ce024c5ac55af7bdf8.svg" src="../../_images/ca49675099f9f2ef2a6eefe29fd7c42a1bdc68dd3a15d7ce024c5ac55af7bdf8.svg" />
</div>
</div>
</section>
<section id="qq-plot">
<h4>QQ plot<a class="headerlink" href="#qq-plot" title="Link to this heading">#</a></h4>
<p>The histograms above look like normal distributions, but it’s sometimes hard to tell.
A quantile-quantile (QQ) plot is another way to check normality:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quantiles</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">normal_quantiles</span> <span class="o">=</span> <span class="n">jstats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>
<span class="n">error_quantiles</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">standardized_errors</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;QQ plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">normal_quantiles</span><span class="p">,</span> <span class="n">error_quantiles</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Normal quantiles&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error quantiles&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/4c60eba033c7a43231456725d9e3dc7f6e1bc0792919d35e7caf76a0da556941.svg" src="../../_images/4c60eba033c7a43231456725d9e3dc7f6e1bc0792919d35e7caf76a0da556941.svg" />
</div>
</div>
<p>The straighter the line, the more “normal” the errors are. They look decent.</p>
</section>
<section id="residuals-plot">
<h4>Residuals plot<a class="headerlink" href="#residuals-plot" title="Link to this heading">#</a></h4>
<p>Another assumption in our GP model is that the noise is <em>homoscedastic</em>—i.e., the same across all input/output values. We can check this assumption by plotting the error against the model prediction. This is called a <em>residual plot</em>. (Note that <em>residuals</em> is just another name for the errors.)</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Residual plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">means_test</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">standardized_errors</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;95% CI&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Standardized error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/5e554fe092fa58257dd9847c37e9ea28e647d7b2fcb2c3186b6ea4af360fa883.svg" src="../../_images/5e554fe092fa58257dd9847c37e9ea28e647d7b2fcb2c3186b6ea4af360fa883.svg" />
</div>
</div>
<p>The variance in the errors seems to change with the output value. Similar to the parity plots, this basically tells us that the GP fit is somewhat off and we may need more training data. (Whether we actually use more data depends, of course, on how accurate we need our surrogate to be.)</p>
</section>
</section>
</section>
<section id="sensitivity-analysis-with-surrogate">
<h2>Sensitivity analysis with surrogate<a class="headerlink" href="#sensitivity-analysis-with-surrogate" title="Link to this heading">#</a></h2>
<p>Now that we have a trained and tested surrogate, there are many useful things we can do with it. As an example, we’ll demonstrate using the surrogate to do Sobol sensitivity analysis.</p>
<p>First, let’s get the ranges over which we expect the inputs to vary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">SALib.sample.sobol</span> <span class="k">as</span> <span class="nn">sobol</span>
<span class="kn">import</span> <span class="nn">SALib.analyze.sobol</span> <span class="k">as</span> <span class="nn">analyze_sobol</span>

<span class="n">input_bounds_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;viscosity_cP&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],</span>
    <span class="s1">&#39;fill_volume_mL&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">],</span>
    <span class="s1">&#39;air_gap_height_mm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
    <span class="s1">&#39;needle_length_mm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">15.9</span><span class="p">],</span>
    <span class="s1">&#39;needle_diameter_mm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.133</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">],</span>
    <span class="s1">&#39;spring_force_N&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">18.0</span><span class="p">,</span> <span class="mf">36.0</span><span class="p">],</span>
    <span class="s1">&#39;spring_constant_N_per_mm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">150.0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">],</span>
    <span class="s1">&#39;kappa5&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span>
    <span class="s1">&#39;kappa6&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
    <span class="s1">&#39;kappa7&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">input_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">input_bounds_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_bounds_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">INPUT_NAMES</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The input bounds are:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">input_bounds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The input bounds are:
 [[1.00e+00 2.00e+01]
 [1.00e+00 1.05e+00]
 [4.00e+00 5.00e+00]
 [8.00e+00 1.59e+01]
 [1.33e-01 2.10e-01]
 [1.80e+01 3.60e+01]
 [1.50e+02 2.50e+02]
 [0.00e+00 3.00e+00]
 [0.00e+00 4.00e+00]
 [0.00e+00 1.00e-01]]
</pre></div>
</div>
</div>
</div>
<p>Next, we create Sobol samples of the inputs and pass them through the surrogate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">problem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;num_vars&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">INPUT_NAMES</span><span class="p">),</span>
    <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">INPUT_NAMES</span><span class="p">,</span>
    <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="n">input_bounds</span>
<span class="p">}</span>

<span class="c1"># The number of samples to generate (should be a power of 2).</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">512</span>

<span class="c1"># Generate the samples.</span>
<span class="n">sobol_samples</span> <span class="o">=</span> <span class="n">sobol</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">calc_second_order</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Evaluate the surrogate model at the Sobol samples.</span>
<span class="n">sobol_outputs</span> <span class="o">=</span> <span class="n">surrogate</span><span class="p">(</span><span class="n">sobol_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we calculate and plot the Sobol indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sobol_indices</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">sobol_indices</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">analyze_sobol</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">sobol_outputs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">calc_second_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_to_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/holtw/Documents/mydocs/software/advanced-scientific-machine-learning/.venv/lib/python3.11/site-packages/SALib/util/__init__.py:274: FutureWarning: unique with argument that is not not a Series, Index, ExtensionArray, or np.ndarray is deprecated and will raise in a future version.
  names = list(pd.unique(groups))
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot sobol indices</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sobol indices&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">problem</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">],</span> <span class="n">sobol_indices</span><span class="p">[</span><span class="n">o_name</span><span class="p">][</span><span class="s1">&#39;S1&#39;</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../../_images/40d26fe5d2de299806e66b2e0a5c775aecb653d7277ed681607a2facc604cff1.svg" src="../../_images/40d26fe5d2de299806e66b2e0a5c775aecb653d7277ed681607a2facc604cff1.svg" />
</div>
</div>
<p>Excellent! We now know to which inputs the outputs are most sensitive. For example, we can see that the injection time is very sensitive to the drug viscosity and needle diameter, somewhat sensitive to needle length and injector spring force, and not sensitive to any other inputs. This information can be used, for example, to further study and understand the physics behind the model, or to investigate how identifiable each parameter is given an experimental dataset.</p>
<p>Remember that <strong>sensitivity analysis would have been impossible without a surrogate model</strong>—the true physical model was just too expensive to evaluate. With a surrogate however, we can do sensitivity analysis, design optimization, uncertainty quantification, etc. all at a reasonable computational cost.</p>
</section>
<section id="training-and-inference">
<h2>Training and inference<a class="headerlink" href="#training-and-inference" title="Link to this heading">#</a></h2>
<p>At this point, we have two options on how to proceed. We can either do:</p>
<ol class="arabic simple">
<li><p><strong>Exact GP regression</strong>. Accurate but doesn’t scale well. Good for small datasets (up to a few thousand points).</p></li>
<li><p><strong>Approximate GP regression</strong>. Scalable to large datasets (million or more points).</p></li>
</ol>
<p>Our dataset <span class="math notranslate nohighlight">\((N=10,000)\)</span> is mid-sized, so either option is feasible. We’ll show both.</p>
<section id="option-1-exact-gp-regression">
<h3>Option 1: Exact GP regression<a class="headerlink" href="#option-1-exact-gp-regression" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means_exact</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">stdevs_exact</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">latent_dist_exact</span> <span class="o">=</span> <span class="n">posteriors_exact</span><span class="p">[</span><span class="n">o_name</span><span class="p">](</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">train_data</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">])</span>
    <span class="n">predictive_dist_exact</span> <span class="o">=</span> <span class="n">posteriors_exact</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="n">latent_dist_exact</span><span class="p">)</span>
    <span class="n">means_exact</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictive_dist_exact</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">stdevs_exact</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictive_dist_exact</span><span class="o">.</span><span class="n">stddev</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">y_test_scaled</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">means_exact</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">stdevs_exact</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ELBO&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/df89a6559c904404ed8401cfaff0ba566a21df978052849c3a82bb4a910ba21e.svg" src="../../_images/df89a6559c904404ed8401cfaff0ba566a21df978052849c3a82bb4a910ba21e.svg" />
</div>
</div>
</section>
<section id="option-2-approximate-gp-regression">
<h3>Option 2: Approximate GP regression<a class="headerlink" href="#option-2-approximate-gp-regression" title="Link to this heading">#</a></h3>
<p>There are actually several different flavors of approximate GP regression.
We will do <em>sparse variational Gaussian process</em> (SVGP) regression as described in <a class="reference external" href="https://proceedings.mlr.press/v38/hensman15.html">Hensman et al. (2015)</a>.</p>
<p>The idea is to <strong>do variational inference to approximate the posterior GP.</strong> In particular, approximate the true predictive Gaussian process</p>
<div class="math notranslate nohighlight">
\[
p\big(f(\cdot) | \mathcal{D}\big) = \int p\big(f(\cdot) \big| f(\mathbf{x})\big) p\big(f(\mathbf{x}) \big| \mathcal{D}\big) df(\mathbf{x})
\]</div>
<p>with an <em>approximate process</em> <span class="math notranslate nohighlight">\(q(f(\cdot))\)</span>.</p>
<p>How is this done?</p>
<!-- First, you must select a set of *inducing inputs* $z$. Next, assume that the dataset $\mathcal{D}$ is actually redudant and that all you really need to get the GP posterior are the function values at $z$.

![inducing-inputs](inducing-inputs.png) -->
<ol class="arabic simple">
<li><p><strong>Create a smaller, representative dataset.</strong>
Pick a set of <span class="math notranslate nohighlight">\(M \ll N\)</span> points <span class="math notranslate nohighlight">\(z\)</span> called <em>inducing inputs</em>. Assume that a posterior created from just these <span class="math notranslate nohighlight">\(M\)</span> points is approximately equal to the true posterior.
To visualize this, see the figure below (from GPJax docs), where the blue x’s are the data and the orange lines are the inducing inputs <span class="math notranslate nohighlight">\(z\)</span>.</p></li>
</ol>
<p>         
<img src="inducing-inputs.png" alt="inducing-inputs" width="400"/></p>
<!-- So instead of using the all the inputs, e.g., 

$$
\mathbf{X}=\underbrace{[0, 0.0001, 0.0002, \dots, 0.9999, 1]}_{N=10,000}
$$

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
use a smaller set of inducing inputs, e.g.,

$$
\mathbf{Z}=\underbrace{[0, 0.05, 0.1, \dots, 0.95, 1]}_{M=20}.
$$ -->
<ol class="arabic simple" start="2">
<li><p><strong>Approximate the posterior distribution of “induced outputs”, <span class="math notranslate nohighlight">\(p(f(z)|\mathcal{D})\)</span>.</strong>
This is where the variational approximation happens.
Let <span class="math notranslate nohighlight">\(q_\phi\)</span> be a distribution parameterized by <span class="math notranslate nohighlight">\(\phi\)</span>. A common choice for <span class="math notranslate nohighlight">\(q_\phi\)</span> is a Gaussian parameterized by <span class="math notranslate nohighlight">\(\phi=(z, \mathbf{m}, \mathbf{S})\)</span> so that</p></li>
</ol>
<div class="math notranslate nohighlight">
\[
q_\phi \equiv q\big(f(z)\big) \equiv \mathcal{N}\big(f(z)\big| \mathbf{m}, \mathbf{S}\big).
\]</div>
<p>         
<span class="math notranslate nohighlight">\(q_\phi\)</span> is often just called the <em>guide</em>.</p>
<ol class="arabic simple" start="3">
<li><p><strong>Minimize the discrepancy between the true and approximate posteriors with respect to variational parameters <span class="math notranslate nohighlight">\(\phi\)</span>.</strong> This is done by minimizing an appropriate Evidence Lower Bound (ELBO). For details on the specific form for the ELBO, see sections 3.1 and 4.1 of the review paper <a class="reference external" href="https://arxiv.org/abs/2012.13962">Leibfried et al. (2020)</a>.</p></li>
</ol>
<p>         
Note that the inducing inputs <span class="math notranslate nohighlight">\(z\)</span> are optimized.</p>
<!-- $$
\begin{align*}
p(f(\cdot) | \mathbf{X}, \mathbf{y}) &= \int p(f(\cdot) | f(\mathbf{Z})) p(f(\mathbf{Z}) | \mathbf{X}, \mathbf{y}) df(\mathbf{Z}) \\
\end{align*}
$$

In particular, let $q_\phi$ be a distribution parameterized by $\phi$. While $q$ could be anything, a common choice is a Gaussian so that

$$
q_\phi \equiv q_{\underbrace{(\mathbf{z}, \mathbf{m}, \mathbf{S})}_{\equiv \phi}} \equiv q(f(\mathbf{z})) = \mathcal{N}(f(\mathbf{z})| \mathbf{m}, \mathbf{S})
$$

$q_\phi(f)$  \approx p(f | \mathbf{X}, \mathbf{y})$. -->
<p>Fortunately, this is all already implemented in <code class="docutils literal notranslate"><span class="pre">GPJax</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Initialize inducing inputs</span>
<span class="c1"># z = jrandom.uniform(key, shape=(300, len(INPUT_NAMES)), minval=-2.0, maxval=2.0)</span>

<span class="c1"># # Initialize the process that will approximate the true GP posterior</span>
<span class="c1"># guides = {}</span>
<span class="c1"># for i, o_name in enumerate(OUTPUT_NAMES):</span>
<span class="c1">#     guides[o_name] = gpx.variational_families.CollapsedVariationalGaussian(posterior=posteriors[o_name], inducing_inputs=z)</span>

<span class="c1"># # Learning rate schedule</span>
<span class="c1"># schedule = optax.warmup_cosine_decay_schedule(</span>
<span class="c1">#     init_value=0.0,</span>
<span class="c1">#     peak_value=0.1,</span>
<span class="c1">#     warmup_steps=75,</span>
<span class="c1">#     decay_steps=2000,</span>
<span class="c1">#     end_value=0.001,</span>
<span class="c1"># )</span>

<span class="c1"># # Learn the variational parameters phi with Adam</span>
<span class="c1"># loss_histories_approx = {}</span>
<span class="c1"># for i, o_name in enumerate(OUTPUT_NAMES):</span>
<span class="c1">#     key, subkey = jrandom.split(key)</span>
<span class="c1">#     guides[o_name], loss_histories_approx[o_name] = gpx.fit(</span>
<span class="c1">#         model=guides[o_name],</span>
<span class="c1">#         objective=lambda p, d: -gpx.objectives.collapsed_elbo(p, d),</span>
<span class="c1">#         train_data=datasets[o_name],</span>
<span class="c1">#         optim=optax.adam(learning_rate=schedule),</span>
<span class="c1">#         num_iters=3000,</span>
<span class="c1">#         key=subkey,</span>
<span class="c1">#         batch_size=128,</span>
<span class="c1">#     )</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fig, ax = plt.subplots(1, len(OUTPUT_NAMES), figsize=(10, 3), tight_layout=True, sharex=True)</span>
<span class="c1"># for i, o_name in enumerate(OUTPUT_NAMES):</span>
<span class="c1">#     ax[i].plot(loss_histories_approx[o_name])</span>
<span class="c1">#     ax[i].set_title(o_name)</span>
<span class="c1">#     ax[i].set_xlabel(&quot;Iteration&quot;)</span>
<span class="c1">#     ax[i].set_ylabel(&quot;ELBO&quot;)</span>
<span class="c1">#     ax[i].set_yscale(&#39;log&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># means = {}</span>
<span class="c1"># stdevs = {}</span>
<span class="c1"># for i, o_name in enumerate(OUTPUT_NAMES):</span>
<span class="c1">#     latent_dist_approx = guides[o_name](X_train_scaled[:500, :], train_data=datasets[o_name])</span>
<span class="c1">#     predictive_dist_approx = guides[o_name].posterior.likelihood(latent_dist_approx)</span>
<span class="c1">#     means[o_name] = predictive_dist_approx.mean()</span>
<span class="c1">#     stdevs[o_name] = predictive_dist_approx.stddev()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fig, ax = plt.subplots(1, len(OUTPUT_NAMES), figsize=(10, 3), tight_layout=True)</span>
<span class="c1"># for i, o_name in enumerate(OUTPUT_NAMES):</span>
<span class="c1">#     # ax[i].errorbar(y_train_scaled[:,i], means[o_name], yerr=2 * stdevs[o_name], fmt=&#39;o&#39;, ms=2, alpha=0.5, lw=0.1)</span>
<span class="c1">#     ax[i].errorbar(y_train_scaled[:500, i], means[o_name], yerr=2 * stdevs[o_name], fmt=&#39;o&#39;, ms=2, alpha=0.1, lw=0.1)</span>
<span class="c1">#     ax[i].plot(datasets[o_name].y, datasets[o_name].y, &quot;r-&quot;, lw=0.5, zorder=100)</span>
<span class="c1">#     ax[i].set_title(o_name)</span>
<span class="c1">#     ax[i].set_xlabel(&quot;Iteration&quot;)</span>
<span class="c1">#     ax[i].set_ylabel(&quot;ELBO&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p>TODO: Split off into the two options (full vs. sparse)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WARNING: THIS CELL WILL TAKE A FEW MINUTES TO RUN.</span>

<span class="c1"># Initialize inducing inputs</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">jrandom</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">INPUT_NAMES</span><span class="p">)),</span> <span class="n">minval</span><span class="o">=-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

<span class="c1"># Initialize the process that will approximate the true GP posterior</span>
<span class="n">guides</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">guides</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">variational_families</span><span class="o">.</span><span class="n">VariationalGaussian</span><span class="p">(</span><span class="n">posterior</span><span class="o">=</span><span class="n">posterior</span><span class="p">,</span> <span class="n">inducing_inputs</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>

<span class="c1"># Learn the variational parameters phi with Adam</span>
<span class="n">loss_histories_approx</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jrandom</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">guides</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span> <span class="n">loss_histories_approx</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpx</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">guides</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span>
        <span class="n">objective</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="o">-</span><span class="n">gpx</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">elbo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
        <span class="n">train_data</span><span class="o">=</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span>
        <span class="n">optim</span><span class="o">=</span><span class="n">optax</span><span class="o">.</span><span class="n">adamw</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-2</span><span class="p">),</span>
        <span class="n">num_iters</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="n">subkey</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "30eaeff79f674b85a0e6da6a0d87d2bd", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "771d783b20734d92a0e8d09a56b2f12f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "1249476d0d454ed49df08a9a90d37b5a", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "dddaf73954ea4d92a9e7e62ecfba11e0", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_histories_approx</span><span class="p">[</span><span class="n">o_name</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ELBO&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a191c4d04a9cb9950aa8f1fe126f82df8deb93a47ec31e025ea963a14e9050af.svg" src="../../_images/a191c4d04a9cb9950aa8f1fe126f82df8deb93a47ec31e025ea963a14e9050af.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means_approx</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">stdevs_approx</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="n">latent_dist_approx</span> <span class="o">=</span> <span class="n">guides</span><span class="p">[</span><span class="n">o_name</span><span class="p">](</span><span class="n">X_train_scaled</span><span class="p">[:</span><span class="mi">500</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">predictive_dist_approx</span> <span class="o">=</span> <span class="n">guides</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="n">latent_dist_approx</span><span class="p">)</span>
    <span class="n">means_approx</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictive_dist_approx</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">stdevs_approx</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictive_dist_approx</span><span class="o">.</span><span class="n">stddev</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OUTPUT_NAMES</span><span class="p">):</span>
    <span class="c1"># ax[i].errorbar(y_train_scaled[:,i], means[o_name], yerr=2 * stdevs[o_name], fmt=&#39;o&#39;, ms=2, alpha=0.5, lw=0.1)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">y_train_scaled</span><span class="p">[:</span><span class="mi">500</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">means_approx</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">stdevs_approx</span><span class="p">[</span><span class="n">o_name</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">datasets</span><span class="p">[</span><span class="n">o_name</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ELBO&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2c0642f72ff37ae6187d24431993ad665e9bbb70c2078ba6cb8e5ee272a766e6.svg" src="../../_images/2c0642f72ff37ae6187d24431993ad665e9bbb70c2078ba6cb8e5ee272a766e6.svg" />
</div>
</div>
<p>We now have a trained and validated GP surrogate for each output.</p>
</section>
</section>
<section id="design-optimization">
<h2>Design optimization<a class="headerlink" href="#design-optimization" title="Link to this heading">#</a></h2>
<p>Let’s use the surrogates to optimize the design of an autoinjector. We are interested in the minimization problem of the form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
    \min &amp;\quad \mathbb{E}[w_1f_1(\mathbf{x}_d, \mathbf{x}_u) + w_2f_2(\mathbf{x}_d, \mathbf{x}_u) + w_3f_3(\mathbf{x}_d, \mathbf{x}_u)] \\
    \text{s.t.} &amp;\quad f_4(\mathbf{x}_d, \mathbf{x}_u) \leq 2.5
\end{align*}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(w_i\)</span> are positive weights and the expectation is over the uncertain parameters.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./up/surrogates"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-for-subcutaneous-autoinjectors">Model for subcutaneous autoinjectors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset">Dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-regression">Gaussian process regression</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prior">Prior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#likelihood">Likelihood</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#posterior">Posterior</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizing-hyperparameters">Optimizing hyperparameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#predictive-distribution-how-to-evaluate-the-gp">Predictive distribution: How to evaluate the GP?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#convergence-how-much-data-do-we-need">Convergence: How much data do we need?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnostics-how-good-is-the-surrogate">Diagnostics: How good is the surrogate?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parity-plot">Parity plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#standardized-errors">Standardized errors</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#error-histogram">Error histogram</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#qq-plot">QQ plot</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#residuals-plot">Residuals plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitivity-analysis-with-surrogate">Sensitivity analysis with surrogate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-and-inference">Training and inference</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-exact-gp-regression">Option 1: Exact GP regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-approximate-gp-regression">Option 2: Approximate GP regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-optimization">Design optimization</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ilias Bilionis
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>